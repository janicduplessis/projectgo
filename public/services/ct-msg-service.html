<polymer-element name="ct-msg-service" attributes="messages user">
  <template>
    <style>
        :host {
            display: none;
        }
      </style>
  </template>
  <script>
    (function() {
      var _ws = null,
          _messages = [];

      Polymer('ct-msg-service', {
        get messages() {
          return _messages;
        },

        userChanged: function() {
            if(this.user !== null) {
              this.connect()
            }
        },

        sendMessage: function(message) {
          if(_ws === null) {
            return;
          }

          _ws.send(JSON.stringify(message));
        },

        connect: function() {
          if (_ws !== null) {
            return;
          }
          _ws = new WebSocket("ws://localhost:8080/send"),

          _ws.onopen = function(){
          }
     
          _ws.onmessage = function(event){
            _messages.push(JSON.parse(event.data));
          }
     
          _ws.onclose = function(){
            _ws = null;
          }  
        }
      });
  })();
    </script>
</polymer-element>