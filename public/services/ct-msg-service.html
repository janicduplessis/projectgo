<polymer-element name="ct-msg-service" attributes="messages channels">
  <template>
    <style>
        :host {
            display: none;
        }
      </style>
  </template>
  <script>
    (function() {
      var _ws = null,
          _messages = [];
          _channels = {
            List: [],
            Current: -1
          };

      function connect() {
        if (_ws !== null) {
          console.log('Websocket not connected');
          return;
        }
        _ws = new WebSocket('ws://' + window.location.host + '/ct'),

        _ws.onopen = function(){
          updateChannels();
        }
   
        _ws.onmessage = function (event){
          var cmd = JSON.parse(event.data);
          switch(cmd.Command) {
          case "SendMessage":
            _messages.push(cmd.Data);
            break;
          case "Channels":
            _channels.List = cmd.Data.List;
            break;
          case "CreateChannel":
            _channels.List.push(cmd.Data);
            break;
          }
          
        }
   
        _ws.onclose = function(){
          _ws = null;
        }
      }

      function disconnect() {
        _ws.onclose = function() {};
        _ws.close();
        _ws = null;
      }

      function updateChannels() {
        if(_ws === null) {
            console.log('Websocket not connected');
            return;
          }

          _ws.send(JSON.stringify({
            Command: "Channels"
         }));
      }

      document.addEventListener('log-in', function() {
        connect();
      });
      document.addEventListener('log-out', function() {
        disconnect();
      });

      Polymer('ct-msg-service', {

        ready: function() {
          this.messages = _messages;
          this.channels = _channels;
        },

        sendMessage: function(message) {
          if(_ws === null) {
            console.log('Websocket not connected');
            return;
          }

          _ws.send(JSON.stringify({
            Command: "SendMessage",
            Data: {Message: message}
         }));
        },

        joinChannel: function(channelId) {
          if(_ws === null) {
            console.log('Websocket not connected');
            return;
          }
          this.channels.Current = channelId;
          _ws.send(JSON.stringify({
            Command: "JoinChannel",
            Data: {ChannelId: channelId}
         }));
        },

        createChannel: function(name) {
          if(_ws === null) {
            console.log('Websocket not connected');
            return;
          }

          _ws.send(JSON.stringify({
            Command: "CreateChannel",
            Data: {Name: name}
         }));
        },

        updateChannels: function() {
          updateChannels();
        }
      });
  })();
    </script>
</polymer-element>