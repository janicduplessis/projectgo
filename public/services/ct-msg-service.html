<polymer-element name="ct-msg-service" attributes="messages">
  <template>
    <style>
        :host {
            display: none;
        }
      </style>
  </template>
  <script>
    (function() {
      var _ws = null,
          _messages = [];

      function connect() {
        if (_ws !== null) {
          return;
        }
        _ws = new WebSocket('ws://' + window.location.host + ':8080/send'),

        _ws.onopen = function(){
        }
   
        _ws.onmessage = function(event){
          var newMessages = JSON.parse(event.data);
          for(var i = 0; i < newMessages.length; i++) {
            _messages.push(newMessages[i]);
          }
        }
   
        _ws.onclose = function(){
          _ws = null;
        }
      }

      function disconnect() {
        _ws.onclose = function() {};
        _ws.close();
      }

      document.addEventListener('log-in', function() {
        connect();
      });
      document.addEventListener('log-out', function() {
        disconnect();
      });

      Polymer('ct-msg-service', {

        ready: function() {
          this.messages = _messages;
        },

        sendMessage: function(message) {
          if(_ws === null) {
            return;
          }

          _ws.send(JSON.stringify(message));
        },
      });
  })();
    </script>
</polymer-element>