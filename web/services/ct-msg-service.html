<polymer-element name="ct-msg-service" attributes="messages channels">
  <template>
    <style>
        :host {
            display: none;
        }
      </style>
  </template>
  <script>
    (function() {
      var _ws = null,
          _messages = {
            List: [],
            Total: 0
          },
          _channels = {
            List: [],
            Current: -1
          },
          _handlers;

      function connect() {
        if (_ws !== null) {
          console.log('Websocket not connected');
          return;
        }
        _ws = new WebSocket('ws://' + window.location.host + '/ct'),

        _ws.onopen = function(){
          updateChannels();
        }
   
        _ws.onmessage = function (event){
          var cmd = JSON.parse(event.data);
          if(!_handlers[cmd.Command]) {
            console.log("invalid command");
            return;
          }
          
          _handlers[cmd.Command](cmd.Data);
        }
   
        _ws.onclose = function(){
          _ws = null;
        }
      }

      function disconnect() {
        if(_ws === null) {
          return;
        }
        _ws.onclose = function() {};
        _ws.close();
        _ws = null;
      }

      function updateChannels() {
        if(_ws === null) {
            console.log('Websocket not connected');
            return;
          }

          _ws.send(JSON.stringify({
            Command: "Channels"
         }));
      }

      document.addEventListener('log-in', function() {
        connect();
      });
      document.addEventListener('log-out', function() {
        disconnect();
      });

      // Command handlers, function name must match command name
      _handlers = {
        SendMessage: function(data) {
          _messages.List.push(data);
        },
        Channels: function(data) {
          _channels.List = data.List;
        },
        CreateChannel: function(data) {
          _channels.List.push(data);
        },
        JoinChannel: function(data) {
          _messages.List = data.Messages;
        },
        ChannelJoined: function(data) {
          var channel;
          for (var i = 0; i < _channels.List.length; i++) {
            var curChan = _channels.List[i];
            // Check if the client is already in a channel and remove it
            var index = curChan.Clients.map(function(e) {return e.Id}).indexOf(data.Client.Id);
            if(index !== -1) {
              curChan.Clients.splice(index, 1);
            }
            
            // Find the channel object by id
            if(curChan.Id === data.ChannelId) {
              channel = curChan;
            }
          }
          channel.Clients.push(data.Client)
        },
        Error: function(data) {
          console.log(JSON.stringify(data));
        }
      }

      Polymer('ct-msg-service', {

        ready: function() {
          this.messages = _messages;
          this.channels = _channels;
        },

        sendMessage: function(message) {
          if(_ws === null) {
            console.log('Websocket not connected');
            return;
          }

          _ws.send(JSON.stringify({
            Command: "SendMessage",
            Data: {Message: message}
         }));
        },

        joinChannel: function(channelId) {
          if(_ws === null) {
            console.log('Websocket not connected');
            return;
          }
          this.channels.Current = channelId;
          _ws.send(JSON.stringify({
            Command: "JoinChannel",
            Data: {ChannelId: channelId}
         }));
        },

        createChannel: function(name) {
          if(_ws === null) {
            console.log('Websocket not connected');
            return;
          }

          _ws.send(JSON.stringify({
            Command: "CreateChannel",
            Data: {Name: name}
         }));
        },

        updateChannels: function() {
          updateChannels();
        }
      });
  })();
    </script>
</polymer-element>