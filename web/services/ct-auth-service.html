<link rel="import" href="/lib/core-ajax/core-ajax.html">
<link rel="import" href="/lib/core-localstorage/core-localstorage.html">

<polymer-element name="ct-auth-service">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
		<core-ajax id="login"
				 url="/login"
				 method="POST"
				 handleAs="json"
				 body="{{bodyLogin}}"
				 on-core-response="{{loginResponse}}">
		</core-ajax>
		<core-ajax id="register" 
				 url="/register" 
				 method="POST" 
				 handleAs="json" 
				 body="{{bodyRegister}}" 
				 on-core-response="{{registerResponse}}">
		</core-ajax>
		<core-ajax id="logout"
				 url="/logout"
				 method="POST"
				 handleAs="json">
		</core-ajax>

		<core-localstorage id="storage" name="ct-user" on-core-localstorage-load="{{storageLoaded}}"></core-localstorage>
	</template>
	<script>
		(function() {
			var _user = {
				logged: false,
				identity: null
			};

			Polymer('ct-auth-service', {
				get user() {
					return _user;
				},
				storageLoaded: function() {
					var user = this.$.storage.value;
					if(user && user.logged && user.identity) {
						_user = user;
						if(this.user.logged) {
							this.fire('log-in', this.user);
						}
					} else if(ct.utils.getCookie('ctuserinfo')) {
						_user.identity = JSON.parse(decodeURIComponent(ct.utils.getCookie('ctuserinfo')));
						_user.logged = true;
						this.fire('log-in', this.user);
					}
					this.fire('ct-auth-ready');
				},
				login: function(username, password) {
					var loginInfo = {
						Username: username,
						Password: password
					};
					this.bodyLogin = JSON.stringify(loginInfo);
					this.$.login.go();
				},
				register: function(username, password, firstName, lastName, email) {
					var registerInfo = {
						Username: username,
						Password: password,
						FirstName: firstName,
						LastName: lastName,
						Email: email
					};
					this.bodyRegister = JSON.stringify(registerInfo);
					this.$.register.go();
				},
				logout: function() {
					this.user.logged = false;
					this.user.identity = null;
					this.$.logout.go();
					localStorage.clear();
					this.fire('log-out');
				},
				loginResponse: function(event) {
					var response = event.detail.response;
					if(response.Result) {
						this.user.logged = true;
						this.user.identity = response.User;
						this.fire('log-in', response.User);
					} else {
						this.user.logged = false;
						this.user.identity = null;
					}
					this.$.storage.value = this.user;
					this.fire('ct-login', {result: response.Result, user: response.User});
				},
				registerResponse: function(event) {
					var response = event.detail.response;
					if(response.Result) {
						this.user.logged = true;
						this.user.identity = response.User;
						this.fire('log-in', response.User);
					} else {
						this.user.logged = false;
						this.user.identity = null;
					}
					this.$.storage.value = this.user;
					this.fire('ct-register', {result: response.Result, user: response.User, error: response.Error});
				}
			});
		})();
	</script>
</polymer-element>